/*
azure-maps-spider-clusters Version: 0.0.1

MIT License - Copyright (c) Microsoft Corporation.
*/


!function(e,L){"use strict";var r=function(e,t){return(r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(e,t)};var _,t,i,a=(_=L.internal.EventEmitter,r(t=o,i=_),t.prototype=null===i?Object.create(i):(s.prototype=i.prototype,new s),o.prototype.dispose=function(){var e=this,t=e._map,r=t.events,i=e._spiderFeatureLayer,a=e._layerClickEvent,s=e.hideSpiderCluster;r.remove("click",s),r.remove("movestart",s),r.remove("click",e._clusterLayer,a),r.remove("mouseleave",i,e._unhighlightStick),r.remove("mousemove",i,e._highlightStick),r.remove("click",i,a),r.remove("click",e._unclustedLayer,a),t.layers.remove(i),e._spiderFeatureLayer=null,t.layers.remove(e._spiderLineLayer),e._spiderLineLayer=null,e._spiderDataSource.clear(),t.sources.remove(e._spiderDataSource),e._spiderDataSource=null},o.prototype.getOptions=function(){return JSON.parse(JSON.stringify(this._options))},o.prototype.getLayers=function(){var e=this;return{clusterLayer:e._clusterLayer,unclustedLayer:e._unclustedLayer,spiderFeatureLayer:e._spiderFeatureLayer,spiderLineLayer:e._spiderLineLayer}},o.prototype.setOptions=function(e){var t=this,r=t._options;t.hideSpiderCluster(),e&&("number"==typeof e.circleSpiralSwitchover&&(r.circleSpiralSwitchover=e.circleSpiralSwitchover),"number"==typeof e.maxFeaturesInWeb&&(r.maxFeaturesInWeb=e.maxFeaturesInWeb),"number"==typeof e.minSpiralAngleSeperation&&(r.minSpiralAngleSeperation=e.minSpiralAngleSeperation),"number"==typeof e.spiralDistanceFactor&&(r.spiralDistanceFactor=e.spiralDistanceFactor),"number"==typeof e.minCircleLength&&(r.minCircleLength=e.minCircleLength),"boolean"==typeof e.closeWebOnPointClick&&(r.closeWebOnPointClick=e.closeWebOnPointClick),e.stickLayerOptions&&(r.stickLayerOptions=e.stickLayerOptions,t._spiderLineLayer.setOptions(e.stickLayerOptions)),"boolean"==typeof e.visible&&r.visible!==e.visible&&(r.visible=e.visible,t._spiderLineLayer.setOptions({visible:e.visible}),t._spiderFeatureLayer.setOptions({visible:e.visible})))},o.prototype.showSpiderCluster=function(v){var y=this,S=this,g=S._options,e=S._spiderDataSource.getShapes();if(v&&v.properties.cluster){var m=v.properties.cluster_id;if(0<e.length&&e[0].getProperties().cluster_id===m)return;S.hideSpiderCluster(),S._datasource.getClusterLeaves(m,g.maxFeaturesInWeb,0).then(function(e){var t,r,i,a=v.geometry.coordinates,s=S._map.positionsToPixels([a])[0],o=0,n=e.length>g.circleSpiralSwitchover;n?(t=g.minCircleLength/Math.PI,i=2*Math.PI*g.spiralDistanceFactor):(r=2*Math.PI/e.length,(t=g.spiralDistanceFactor/r/Math.PI/2*e.length)<g.minCircleLength&&(t=g.minCircleLength));for(var c=[],l=0,p=e.length;l<p;l++){n?t+=i/(o+=g.minSpiralAngleSeperation/t+5e-4*l):o=r*l;var u=S._map.pixelsToPositions([[s[0]+t*Math.cos(o),s[1]+t*Math.sin(o)]])[0];c.push(new L.data.Feature(new L.data.LineString([a,u]),null,l+""));var d=e[l],h=d instanceof L.Shape?d.getId():d.id,_=Object.assign({},d instanceof L.Shape?d.getProperties():d.properties);_._stickId=l+"",_._parentId=h,_._cluster=m,c.push(new L.data.Feature(new L.data.Point(u),_))}y._spiderDataSource.add(c)})}},o);function s(){this.constructor=t}function o(e,t,r,i){var o=_.call(this)||this;o._hoverStateId=null,o._options={circleSpiralSwitchover:6,minCircleLength:30,minSpiralAngleSeperation:25,spiralDistanceFactor:5,maxFeaturesInWeb:100,closeWebOnPointClick:!0,stickLayerOptions:{strokeColor:["case",["boolean",["feature-state","hover"],!1],"red","black"]}},o.hideSpiderCluster=function(e){var t=o;(!e||t._options.closeWebOnPointClick||!t._options.closeWebOnPointClick&&e.shapes&&0<e.shapes.length&&e.shapes[0]instanceof L.Shape&&e.shapes[0].dataSource&&e.shapes[0].dataSource.id!==t._spiderDataSource.getId())&&t._spiderDataSource.clear()},o._layerClickEvent=function(e){var t=o;if(e&&e.shapes&&0<e.shapes.length){var r,i,a=void 0,s=void 0;r=e.shapes[0]instanceof L.Shape?(a=(s=e.shapes[0]).getProperties(),s.getCoordinates()):(a=(i=e.shapes[0]).properties,i.geometry.coordinates),i&&a.cluster?(t._invokeEvent("featureUnselected",null),t._currentCluster=e.shapes[0],t._datasource.getClusterExpansionZoom(a.cluster_id).then(function(e){e<=t._map.getCamera().maxZoom?t._map.setCamera({center:r,zoom:e,type:"ease",duration:200}):t.showSpiderCluster(i)})):(void 0!==a._parentId?s=t._datasource.getShapeById(a._parentId):t._currentCluster=null,s&&t._invokeEvent("featureSelected",{cluster:t._currentCluster,shape:s}),t._options.closeWebOnPointClick&&t.hideSpiderCluster()),e.preventDefault()}},o._highlightStick=function(e){var t=o;if(e&&e.shapes&&0<e.shapes.length){var r=void 0;r=e.shapes[0]instanceof L.Shape?e.shapes[0].getProperties()._stickId:e.shapes[0].properties._stickId;var i={source:t._spiderDatasourceId,id:t._hoverStateId},a=t._map;t._hoverStateId&&a.map.setFeatureState(i,{hover:!1}),t._hoverStateId=r,i.id=r,a.map.setFeatureState(i,{hover:!0}),a.getCanvasContainer().style.cursor="pointer"}},o._unhighlightStick=function(e){var t=o;t._hoverStateId&&(t._map.map.setFeatureState({source:t._spiderDatasourceId,id:t._hoverStateId},{hover:!1}),t._hoverStateId=null,t._map.getCanvasContainer().style.cursor="grab")};var a=o,s=L.layer;a._map=e;var n=(a._clusterLayer=t).getSource();if("string"==typeof n&&(n=e.sources.getById(n)),!(n instanceof L.source.DataSource))throw"Data source on cluster layer is not supported.";a._datasource=n,i=i||{};var c=new L.source.DataSource;a._spiderDataSource=c,e.sources.add(c),a._spiderDatasourceId=c.getId(),a._spiderLineLayer=new s.LineLayer(c,null,a._options.stickLayerOptions),e.layers.add(a._spiderLineLayer);var l,p=Object.assign({},r.getOptions());p.source=void 0,p.filter=["any",["==",["geometry-type"],"Point"],["==",["geometry-type"],"MultiPoint"]],l=(a._unclustedLayer=r)instanceof s.BubbleLayer?new s.BubbleLayer(c,null,p):(p.iconOptions=p.iconOptions||{},Object.assign(p.iconOptions,{allowOverlap:!0,ignorePlacement:!0}),new s.SymbolLayer(c,null,p)),a._spiderFeatureLayer=l,e.layers.add(l),a.setOptions(i);var u=e.events,d=a._layerClickEvent,h=a.hideSpiderCluster;return u.add("click",h),u.add("movestart",h),u.add("mouseleave",l,a._unhighlightStick),u.add("mousemove",l,a._highlightStick),u.add("click",t,d),u.add("click",l,d),u.add("click",r,d),o}e.SpiderClusterManager=a}(this.atlas=this.atlas||{},atlas);
